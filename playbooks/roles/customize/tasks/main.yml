---
- name: update hosts file with fqdn
  lineinfile: path=/etc/hosts line="127.0.0.1 {{ server_name }}" regexp=line="127.0.0.1 {{ server_name }}" state=present

- name: Stop jenkins service
  service: name=jenkins state=stopped

- name: Add apt-repo
  apt_repository: repo=ppa:deadsnakes/ppa

- name: Run "apt-get update"
  apt: update_cache=yes

- name: Install software-properties-common
  apt: name={{ item }} state=present
  with_items:
    - python3.7
    - python3-pip

- name: Install requests lib
  command: pip3 install requests

- name: Create all necessary directories with right permissions
  file: path="{{ item }}" state=directory owner=jenkins group=jenkins mode=0755
  with_items:
    - /data/work/nsl
    - /data/work/taxxas
    - /data/work/TaxaaS
    - /data/processing/config/.ssh
    - /data/work/NSL-ICN
    - /data/work/NSL-ICNP
    - /data/work/NSL-ICVCN
    - /data/work/NSL-ICZN
    - /data/work/ANBG-MOSS
    - /data/work/ANBG-LICH
    - /data/work/ANBG-VASC
    - /data/work/ANBG-ALGAE
    - /data/work/ANBG-FUNGI
    - /data/processing/ANBG
    - /data/archive
    - /var/lib/jenkins/jobs/Build_Solr
  
- name: Sync the NSL processing directores with ANBG
  script: copy-nsl-files-to-anbg.sh

- name: Adjust group permissions on /data/bie/import folder
  file: path=/data/bie/import state=directory mode=0775

- name: Copy the config file to the Build_Solr directory
  copy: src=Build_Solr_config.xml dest=/var/lib/jenkins/jobs/Build_Solr/config.xml owner=jenkins group=jenkins mode=755

- name: Add jenkins to tomcat group
  user: name=jenkins groups=tomcat7

- name: Copy the key file to copy the csv file
  copy: src=pki/dawr.pem dest="/data/processing/config/.ssh/dawr.pem" owner=jenkins group=jenkins mode=400

- name: update the jenkins args in the jenkins config file
  lineinfile: path="/etc/default/jenkins" line='JENKINS_ARGS="--webroot=/var/cache/$NAME/war --httpPort=$HTTP_PORT --prefix=$PREFIX"' regexp='^JENKINS_ARGS="--webroot=/var/cache/$NAME/war --httpPort=$HTTP_PORT --prefix=$PREFIX"' state=present

- name: Make sure folder /etc/nginx/ssl is created with right permissions
  file: path=/etc/nginx/ssl state=directory owner=root mode=0755

- name: Copy ssl certificate to nginx conf directory and rename
  copy: src=pki/certificate.pem dest="/etc/nginx/ssl/{{server_name}}.self.crt" mode=644
  become: true

- name: Copy the key file to the nginx conf dir and rename
  copy: src=./pki/key.pem dest="/etc/nginx/ssl/{{server_name}}.self.key" mode=400
  become: true

- name: Remove existing nginx configuration
  command: bash -c "mv /etc/nginx/sites-available/{{server_name}}.conf /etc/nginx/sites-available/{{server_name}}.conf.bak"

- name: Copy new nginx configuration
  template: src=nginx-jenkins-vhost.conf.j2 dest="/etc/nginx/sites-available/{{server_name}}.conf"

- name: Start jenkins service
  service: name=jenkins state=started

- name: Restart nginx service
  service: name=nginx state=restarted

- name: Restart Jenkins Service
  command: bash -c "sudo systemctl restart jenkins"